---
import HeroSection from "@/components/home/hero-section.astro";
import ExperienceSection from "@/components/home/experience-section";
import ProductsSection from "@/components/home/products-section";
import LatestArticlesSection from "@/components/home/latest-articles-section";
import TechStackSection from "@/components/home/tech-stack-section";
import ImageGallerySection from "@/components/home/image-gallery-section";
import BaseLayout from "@/layouts/BaseLayout.astro";
import { getCollection } from "astro:content";

// 获取所有博客文章并排序
const allPosts = (await getCollection("blog")).sort(
  (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

// 最新 3 篇文章
const latestArticles = allPosts.slice(0, 3).map((post) => ({
  id: post.id.replace(/\.mdx?$/, ""),
  title: post.data.title,
  description: post.data.description,
  coverImage: post.data.heroImage,
}));

// 按年份统计文章数量
const postCountByYear = allPosts.reduce(
  (acc, post) => {
    const year = post.data.pubDate.getFullYear();
    acc[year] = (acc[year] || 0) + 1;
    return acc;
  },
  {} as Record<number, number>
);

// 获取所有产品并排序
const allProducts = (await getCollection("products")).sort(
  (a, b) => (a.data.order ?? 99) - (b.data.order ?? 99)
);

const productsData = allProducts.slice(0, 3).map((product) => ({
  id: product.id,
  title: product.data.title,
  description: product.data.description,
  coverImage: product.data.coverImage?.src,
  link: product.data.link,
  githubUrl: product.data.githubUrl,
}));
---

<BaseLayout
  title="Astro shadcn/ui template"
  description="This template helps you build apps with Astro, Tailwind CSS, and shadcn/ui."
>
  <div
    class="mx-auto max-w-5xl min-h-[calc(100vh-128px)] border border-border border-t-0 border-b-0"
  >
    <div class="border-b border-b-border">
      <HeroSection />
    </div>
    <div class="border-b border-b-border">
      <ImageGallerySection client:only="react" />
    </div>
    <div class="border-b border-b-border">
      <LatestArticlesSection
        posts={latestArticles}
        postCountByYear={postCountByYear}
      />
    </div>
    <div class="border-b border-b-border">
      <ExperienceSection />
    </div>
    <div class="border-b border-b-border">
      <ProductsSection products={productsData} />
    </div>
    <div>
      <TechStackSection client:load />
    </div>
  </div>
</BaseLayout>
